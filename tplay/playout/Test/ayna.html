<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jadoo | Buddy✘TV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">
  
  <!-- Clappr Player -->
  <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@clappr/hlsjs-playback@1.0.1/dist/hlsjs-playback.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/level-selector@0.2.0/dist/level-selector.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
    }

    #player {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    @media (max-width: 400px) {
      body {
        transform: scale(0.8);
        transform-origin: top left;
        width: 125%;
        height: 125%;
      }
    }
  </style>
</head>
<body>
  <div id="player"></div>

  <script>
  (function() {
    // --- 1. Full-page loader ---
    const overlay = document.createElement('div');
    overlay.id = 'fullpage-loader';
    overlay.style.cssText = `
      position: fixed; top:0; left:0;
      width:100%; height:100%;
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:99999;
      transition:opacity 0.5s ease;
    `;
    overlay.innerHTML = `
      <div style="
        width:60px;
        height:60px;
        border:6px solid #fff;
        border-top:6px solid #888;
        border-radius:50%;
        animation:spin 1s linear infinite;">
      </div>
      <style>@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}</style>
    `;
    document.body.appendChild(overlay);

    setTimeout(() => {
      overlay.style.opacity = '0';
      setTimeout(() => overlay.remove(), 500);
    }, 2000);

    // --- 2. Load auth HTML and execute scripts ---
    async function loadAuthHtml() {
      try {
        const res = await fetch('api/auth.js?id=cookie'); // your auth HTML endpoint
        const htmlText = await res.text();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlText;

        const scripts = tempDiv.querySelectorAll('script');
        for (let script of scripts) {
          if (script.src) {
            await new Promise((resolve, reject) => {
              const s = document.createElement('script');
              s.src = script.src;
              s.onload = resolve;
              s.onerror = reject;
              document.head.appendChild(s);
            });
          } else {
            eval(script.textContent);
          }
        }

        console.log("Auth HTML executed, cookie should be set");
      } catch (err) {
        console.error("Failed to load auth HTML:", err);
      }
    }

    // --- 3. Initialize player after auth ---
    loadAuthHtml().then(() => {
      console.log("Ready to initialize player");

      // Disable right-click
      document.addEventListener("contextmenu", e => e.preventDefault());

      // Get query parameter (?id=Title)
      const requestedTitle = new URLSearchParams(location.search).get("id");
      if (!requestedTitle) return alert("Missing 'id' parameter");

      fetch("ayna-proxy.json")
        .then(res => res.json())
        .then(json => {
          const list = json.data?.list || [];
          const match = list.find(item => item.title.toLowerCase() === requestedTitle.toLowerCase());
          if (!match) return alert(`Channel "${requestedTitle}" not found`);

          const streamUrl = `api/ayna.m3u8?id=${match.id}`;

          const player = new Clappr.Player({
            source: streamUrl,
            parentId: "#player",
            width: "100%",
            height: "100%",
            autoPlay: true,
            mimeType: "application/x-mpegURL",
            plugins: [HlsjsPlayback, LevelSelector],
            mediacontrol: { seekbar: "#ff0000", buttons: "#eee" }
          });

          player.on(Clappr.Events.PLAYER_ERROR, () => {
            console.warn("Playback error — retrying...");
            setTimeout(() => { player.load(streamUrl); player.play(); }, 500);
          });
        })
        .catch(err => alert("Error loading channel list: " + err));
    });
  })();
  </script>
</body>
</html>
