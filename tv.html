<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>T Play TV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,sans-serif}
body{background:#000;color:#fff;overflow:hidden}

.app{position:relative;width:100vw;height:100vh}
video{width:100%;height:100%;object-fit:fill;background:#000}

/* ===== Loading ===== */
.loading{
  position:absolute;inset:0;
  background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;
  z-index:90
}
.loading.show{display:flex}
.spinner{
  width:60px;height:60px;border-radius:50%;
  border:6px solid rgba(255,255,255,.2);
  border-top-color:#e50914;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== Controller ===== */
.controller{
  position:absolute;bottom:20px;left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.75);
  border-radius:18px;
  padding:12px 18px;
  display:flex;gap:16px;align-items:center;
  opacity:0;pointer-events:none;
  transition:.2s;z-index:60
}
.controller.show{opacity:1;pointer-events:auto}
.ctrl-info{display:flex;gap:12px;align-items:center}
.ctrl-info img{width:52px;height:52px;border-radius:10px}
.ctrl-info b{font-size:16px}
.ctrl-info small{color:#bbb}
.ctrl-btn{
  width:44px;height:44px;border-radius:50%;
  border:none;background:rgba(255,255,255,.2);
  color:#fff;font-size:16px
}

/* ===== Guide ===== */
.guide{
  position:absolute;top:0;left:0;height:100%;
  width:360px;
  background:rgba(0,0,0,.88);
  transform:translateX(-100%);
  transition:.25s;z-index:70;
  overflow-y:auto;padding:10px
}
.guide.show{transform:translateX(0)}
.ch{
  display:flex;gap:10px;align-items:center;
  padding:10px;border-radius:12px;
  cursor:pointer
}
.ch:hover{background:#e50914}
.ch img{width:48px;height:48px;border-radius:10px}
</style>
</head>

<body>

<div class="app">

<video id="video" autoplay playsinline></video>

<div id="loading" class="loading">
  <div class="spinner"></div>
</div>

<!-- Controller -->
<div id="controller" class="controller">
  <div class="ctrl-info">
    <img id="chLogo">
    <div>
      <b id="chName"></b><br>
      <small id="chCat"></small>
    </div>
  </div>
  <button class="ctrl-btn" id="playBtn">
    <i class="fas fa-play"></i>
  </button>
</div>

<!-- Guide -->
<div id="guide" class="guide"></div>

</div>

<script src="main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.12/shaka-player.compiled.js"></script>

<script>
const video = document.getElementById("video");
const loading = document.getElementById("loading");
const controller = document.getElementById("controller");
const guide = document.getElementById("guide");
const playBtn = document.getElementById("playBtn");

let hls=null, shakaP=null;
let index=0;
let lastOk=0, lastBack=0;
let favs = new Set(JSON.parse(localStorage.getItem("favs")||"[]"));

/* ===== Core ===== */
async function playChannel(i){
  index = (i + channels.length) % channels.length;
  localStorage.setItem("last", index);

  cleanup();
  loading.classList.add("show");

  const ch = channels[index];
  const src = ch.sources[0];

  document.getElementById("chLogo").src = ch.img;
  document.getElementById("chName").textContent = (index+1)+". "+ch.name;
  document.getElementById("chCat").textContent = ch.category || "";

  try{
    if(src.type==="dash" || src.url.includes(".mpd")){
      shakaP = new shaka.Player(video);
      if(src.drm){
        await shakaP.configure({
          drm:{clearKeys:{[src.drm.kid]:src.drm.key}}
        });
      }
      await shakaP.load(src.url);
    }else{
      if(Hls.isSupported()){
        hls = new Hls();
        hls.loadSource(src.url);
        hls.attachMedia(video);
      }else{
        video.src = src.url;
      }
    }
    await video.play();
  }catch(e){}

  loading.classList.remove("show");
  showController();
}

/* ===== UI ===== */
function showController(){
  controller.classList.add("show");
  setTimeout(()=>controller.classList.remove("show"),3000);
}
function togglePlay(){
  if(video.paused){
    video.play();
    playBtn.innerHTML='<i class="fas fa-pause"></i>';
  }else{
    video.pause();
    playBtn.innerHTML='<i class="fas fa-play"></i>';
  }
  showController();
}
playBtn.onclick = togglePlay;

function buildGuide(){
  guide.innerHTML="";
  channels.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="ch";
    d.innerHTML=`<img src="${c.img}"><div>${i+1}. ${c.name}</div>`;
    d.onclick=()=>{guide.classList.remove("show");playChannel(i)};
    guide.appendChild(d);
  });
}

/* ===== Cleanup ===== */
function cleanup(){
  if(hls){hls.destroy();hls=null}
  if(shakaP){shakaP.destroy();shakaP=null}
  video.src="";
}

/* ===== Remote / Keyboard ===== */
document.addEventListener("keydown",e=>{
  const now = Date.now();

  if(e.key==="ArrowLeft") playChannel(index-1);
  if(e.key==="ArrowRight") playChannel(index+1);

  if(e.key==="ArrowUp"){
    buildGuide();
    guide.classList.add("show");
  }
  if(e.key==="ArrowDown") showController();

  if(e.key==="Enter"){
    if(now-lastOk < 350){
      const name = channels[index].name;
      favs.has(name)?favs.delete(name):favs.add(name);
      localStorage.setItem("favs",JSON.stringify([...favs]));
    }else{
      togglePlay();
    }
    lastOk = now;
  }

  if(e.key==="Escape"){
    if(now-lastBack < 350){
      window.close();
    }else{
      guide.classList.remove("show");
      controller.classList.remove("show");
    }
    lastBack = now;
  }
});

/* ===== Init ===== */
buildGuide();
playChannel(+localStorage.getItem("last") || 0);
</script>

</body>
</html>
