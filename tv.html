<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T Play - Modern TV Player</title>
    
    <!-- Shaka Player -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.8.5/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.8.5/controls.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Favicon -->
    <link rel="icon" href="https://i.postimg.cc/RCnCv14W/T-Play.png" type="image/png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }
        
        /* Video Container */
        #video-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #000;
            cursor: none;
        }
        
        /* Video Element */
        #video {
            width: 100%;
            height: 100%;
            object-fit: fill;
            background: #000;
        }
        
        /* Watermark */
        .video-logo-watermark {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            opacity: 0.3;
            pointer-events: none;
            mix-blend-mode: screen;
            filter: drop-shadow(0 0 4px rgba(0,0,0,0.3));
            transition: opacity 0.5s ease;
        }
        
        .video-logo-watermark.hidden {
            opacity: 0 !important;
            visibility: hidden;
        }
        
        .video-logo-watermark img {
            display: block;
            height: auto;
            width: 4vw;
            max-width: 45px;
            min-width: 25px;
        }
        
        /* Watermark in Fullscreen */
        #video-container:fullscreen .video-logo-watermark {
            opacity: 0.45 !important;
            visibility: visible !important;
            display: block !important;
        }
        
        /* Loading Spinner */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("https://i.postimg.cc/Pr9sC68t/T-Play-Cover.jpg") center center / cover no-repeat;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-overlay::before {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,.55);
        }
        
        .loading-spinner {
            position: relative;
            z-index: 2;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 7px solid rgba(255,255,255,.18);
            border-top-color: #e50914;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* No Signal Overlay */
        .no-signal {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            justify-content: center;
            background: #000;
            z-index: 96;
        }
        
        .no-signal.show {
            display: flex;
        }
        
        .no-signal i {
            font-size: 64px;
            color: #e50914;
        }
        
        .no-signal span {
            color: #bbb;
            font-size: 16px;
        }
        
        /* Channel Info Bar (Bottom) */
        .info-bar {
            position: absolute;
            left: 50%;
            bottom: 20px;
            transform: translateX(-50%);
            width: min(1120px, 92vw);
            background: rgba(0,0,0,.75);
            border: 1px solid rgba(255,255,255,.12);
            backdrop-filter: blur(8px);
            border-radius: 18px;
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 120;
        }
        
        .info-bar.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .info-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }
        
        .info-logo {
            width: 54px;
            height: 54px;
            border-radius: 12px;
            object-fit: cover;
            background: #111;
        }
        
        .info-text {
            min-width: 0;
        }
        
        .info-title {
            font-size: 17px;
            font-weight: 850;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .info-sub {
            font-size: 13px;
            color: #bbb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .badge {
            display: inline-block;
            margin-left: 8px;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            background: rgba(255,255,255,.16);
            color: #fff;
            vertical-align: middle;
        }
        
        .badge.live {
            background: rgba(229,9,20,.9);
        }
        
        .badge.warn {
            background: rgba(255,255,255,.18);
        }
        
        .badge.err {
            background: rgba(255,255,255,.16);
        }
        
        /* Control Buttons */
        .control-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background: rgba(255,255,255,.16);
            color: #fff;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease, transform 0.2s ease;
        }
        
        .control-btn:hover {
            background: #e50914;
            transform: scale(1.05);
        }
        
        .control-btn.star-on {
            background: rgba(255,213,74,.25);
        }
        
        .control-btn.star-on:hover {
            background: rgba(255,213,74,.35);
        }
        
        /* Custom Progress Bar (Top) */
        .custom-controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: opacity 0.5s ease, transform 0.5s ease;
            opacity: 1;
            z-index: 10;
        }
        
        .custom-controls.hidden {
            opacity: 0;
            transform: translateY(-100%);
            pointer-events: none;
        }
        
        .progress-container {
            width: 100%;
            height: 5px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            transition: height 0.2s ease;
        }
        
        .progress-container:hover {
            height: 7px;
        }
        
        .progress-bar {
            height: 100%;
            background: #e50914;
            border-radius: 3px;
            width: 0%;
            position: relative;
            transition: background 0.2s ease;
        }
        
        .progress-container:hover .progress-bar {
            background: #f40612;
        }
        
        .progress-thumb {
            width: 14px;
            height: 14px;
            background: #e50914;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            right: 0;
            transform: translate(50%, -50%);
            display: none;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        .progress-container:hover .progress-thumb {
            display: block;
        }
        
        /* Time Display */
        .time-display {
            color: white;
            font-size: 14px;
            margin: 0 5px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 15px;
            white-space: nowrap;
            font-variant-numeric: tabular-nums;
            font-weight: 500;
        }
        
        /* Volume Controls */
        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .volume-slider {
            width: 80px;
            height: 5px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            outline: none;
            transition: all 0.2s ease;
        }
        
        .volume-slider:hover {
            height: 7px;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #e50914;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        /* Guide Modal */
        .guide-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: min(520px, 94vw);
            height: min(80vh, 520px);
            background: rgba(0,0,0,.94);
            border: 1px solid rgba(255,255,255,.15);
            backdrop-filter: blur(12px);
            border-radius: 18px;
            display: none;
            flex-direction: column;
            z-index: 130;
            opacity: 0;
            transition: 0.25s ease;
            box-shadow: 0 20px 50px rgba(0,0,0,.8);
        }
        
        .guide-modal.show {
            display: flex;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .guide-header {
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .guide-header b {
            font-size: 14px;
            flex: 1;
        }
        
        .guide-header span {
            font-size: 12px;
            color: #bbb;
            margin-left: 10px;
        }
        
        .guide-close {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,.1);
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 10px;
        }
        
        .guide-close:hover {
            background: #e50914;
        }
        
        .guide-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Categories Sidebar */
        .categories-sidebar {
            width: 150px;
            min-width: 120px;
            overflow-y: auto;
            background: rgba(20,20,20,0.7);
            border-right: 1px solid rgba(255,255,255,.08);
        }
        
        .category-item {
            padding: 12px;
            color: #bbb;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }
        
        .category-item:hover {
            background: rgba(255,255,255,.05);
        }
        
        .category-item.focus {
            background: #e50914;
            color: #fff;
        }
        
        /* Channels Grid */
        .channels-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .search-box {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,.08);
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: none;
            outline: none;
            border-radius: 20px;
            background: rgba(255,255,255,.1);
            color: #fff;
            font-size: 14px;
        }
        
        .channels-grid {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        }
        
        /* Channel Tile */
        .channel-tile {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background: rgba(255,255,255,.05);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .channel-tile:hover {
            background: rgba(255,255,255,.1);
            transform: translateY(-2px);
        }
        
        .channel-tile.focus {
            background: rgba(229,9,20,.2);
            border-color: #e50914;
            transform: scale(1.05);
        }
        
        .channel-logo {
            width: 70px;
            height: 70px;
            object-fit: contain;
            border-radius: 50%;
            background: #111;
            padding: 8px;
            margin-bottom: 8px;
        }
        
        .channel-name {
            font-size: 12px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        .favorite-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,.75);
            color: #bbb;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .favorite-btn:hover {
            background: rgba(0,0,0,.85);
        }
        
        .favorite-btn.on {
            color: #ffd54a;
        }
        
        /* Settings Overlay */
        .settings-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(400px, 85vw);
            max-height: 75vh;
            background: rgba(0,0,0,.94);
            border: 1px solid rgba(255,255,255,.15);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 0;
            display: none;
            flex-direction: column;
            z-index: 150;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0,0,0,.7);
        }
        
        .settings-overlay.show {
            display: flex;
        }
        
        .settings-header {
            padding: 16px 20px;
            background: rgba(25,25,25,.98);
            border-bottom: 1px solid rgba(255,255,255,.12);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-header b {
            font-size: 18px;
        }
        
        .settings-close {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,.1);
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-close:hover {
            background: #e50914;
        }
        
        .settings-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .settings-section {
            margin-bottom: 20px;
        }
        
        .settings-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #ccc;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-title i {
            color: #e50914;
            font-size: 13px;
        }
        
        .settings-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            margin: 6px 0;
            background: rgba(255,255,255,.07);
            border-radius: 10px;
            cursor: pointer;
            transition: .2s;
        }
        
        .settings-option:hover {
            background: rgba(255,255,255,.1);
        }
        
        .settings-option.active {
            background: rgba(229,9,20,.25);
            border-left: 3px solid #e50914;
        }
        
        .option-label {
            font-size: 14px;
            color: #fff;
        }
        
        .option-value {
            font-size: 13px;
            color: #bbb;
            font-weight: 500;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .info-bar {
                bottom: 10px;
                width: 95vw;
                padding: 10px 15px;
            }
            
            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
            
            .video-logo-watermark {
                bottom: 20px;
                right: 20px;
            }
            
            .guide-modal {
                width: 96vw;
                height: 85vh;
            }
            
            .categories-sidebar {
                width: 100px;
            }
            
            .channels-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
            
            .channel-logo {
                width: 60px;
                height: 60px;
            }
        }
        
        @media (max-width: 480px) {
            .info-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .info-logo {
                width: 40px;
                height: 40px;
            }
            
            .info-title {
                font-size: 14px;
            }
            
            .info-sub {
                font-size: 11px;
            }
            
            .control-buttons {
                gap: 5px;
            }
            
            .control-btn {
                width: 36px;
                height: 36px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        
        <!-- Watermark -->
        <div class="video-logo-watermark hidden" id="videoLogoWatermark">
            <img src="https://i.postimg.cc/RCnCv14W/T-Play.png" alt="T Play Logo">
        </div>
        
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- No Signal Overlay -->
        <div class="no-signal" id="noSignal">
            <i class="fas fa-tv"></i>
            <b>No Signal</b>
            <span id="noSignalText">Trying next source…</span>
        </div>
        
        <!-- Custom Controls (Top) -->
        <div class="custom-controls" id="customControls">
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-thumb"></div>
                </div>
            </div>
            <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
        </div>
        
        <!-- Channel Info Bar (Bottom) -->
        <div class="info-bar" id="infoBar">
            <div class="info-left">
                <img id="infoLogo" class="info-logo" alt="Channel Logo">
                <div class="info-text">
                    <div id="infoTitle" class="info-title">Loading…</div>
                    <div id="infoSub" class="info-sub"></div>
                </div>
            </div>
            <div class="control-buttons">
                <button class="control-btn" id="btnPrev" title="Previous Channel">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="control-btn" id="btnPlay" title="Play/Pause">
                    <i class="fas fa-play" id="playIcon"></i>
                </button>
                <button class="control-btn" id="btnNext" title="Next Channel">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div class="volume-container">
                    <button class="control-btn" id="btnMute" title="Mute/Unmute">
                        <i class="fas fa-volume-up" id="muteIcon"></i>
                    </button>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="1">
                </div>
                <button class="control-btn" id="btnFav" title="Favorite">
                    <i class="fas fa-star" id="favIcon"></i>
                </button>
                <button class="control-btn" id="btnGuide" title="Channel Guide">
                    <i class="fas fa-list"></i>
                </button>
                <button class="control-btn" id="btnSettings" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="control-btn" id="btnFullscreen" title="Fullscreen">
                    <i class="fas fa-expand" id="fullscreenIcon"></i>
                </button>
            </div>
        </div>
        
        <!-- Guide Modal -->
        <div class="guide-modal" id="guideModal">
            <div class="guide-header">
                <b>Channel Guide</b>
                <span>←/→ Cat • ↑/↓ Tiles • OK Play • ESC Back</span>
                <button class="guide-close" id="btnCloseGuide">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="guide-body">
                <div class="categories-sidebar" id="categoriesPanel"></div>
                <div class="channels-area">
                    <div class="search-box">
                        <input id="searchInput" placeholder="Search channels..." />
                    </div>
                    <div class="channels-grid" id="channelsGrid"></div>
                </div>
            </div>
        </div>
        
        <!-- Settings Overlay -->
        <div class="settings-overlay" id="settingsOverlay">
            <div class="settings-header">
                <b><i class="fas fa-cog"></i> Settings</b>
                <button class="settings-close" id="btnCloseSettings">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="settings-body">
                <div class="settings-section">
                    <div class="settings-title">
                        <i class="fas fa-tv"></i>
                        <span>Video Resolution</span>
                    </div>
                    <div id="resolutionList">
                        <div class="settings-option active">
                            <div class="option-label">Auto (Best)</div>
                            <div class="option-value">✓</div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">
                        <i class="fas fa-server"></i>
                        <span>Server Source</span>
                    </div>
                    <div id="serverList">
                        <!-- Dynamic server options -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load main.js FIRST before our script -->
    <script src="main.js"></script>

    <script>
        // Global Variables
        let player;
        let channels = window.channels || []; // Load channels from main.js
        let currentIndex = 0;
        let currentSourceIndex = 0;
        let isFullscreen = false;
        let isControlsVisible = true;
        let controlsTimeout;
        let infoHideTimer;
        const HIDE_DELAY = 3000;
        const HIDE_DELAY_NON_FULLSCREEN = 5000;
        
        // Favorites
        const FAV_KEY = "tplay_favs_v1";
        let favorites = loadFavorites();
        
        // Guide State
        let categories = [];
        let currentCategory = "All";
        let filteredIndexes = [];
        let focusCatIndex = 0;
        let focusTileIndex = 0;
        
        // Double click timers
        let okClickTimer = null;
        let backClickTimer = null;
        const DOUBLE_CLICK_DELAY = 400;
        
        // DOM Elements
        const video = document.getElementById('video');
        const videoLogoWatermark = document.getElementById('videoLogoWatermark');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const noSignal = document.getElementById('noSignal');
        const noSignalText = document.getElementById('noSignalText');
        const infoBar = document.getElementById('infoBar');
        const infoLogo = document.getElementById('infoLogo');
        const infoTitle = document.getElementById('infoTitle');
        const infoSub = document.getElementById('infoSub');
        const playIcon = document.getElementById('playIcon');
        const muteIcon = document.getElementById('muteIcon');
        const favIcon = document.getElementById('favIcon');
        const fullscreenIcon = document.getElementById('fullscreenIcon');
        const customControls = document.getElementById('customControls');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const timeDisplay = document.getElementById('timeDisplay');
        const volumeSlider = document.getElementById('volumeSlider');
        const guideModal = document.getElementById('guideModal');
        const categoriesPanel = document.getElementById('categoriesPanel');
        const channelsGrid = document.getElementById('channelsGrid');
        const searchInput = document.getElementById('searchInput');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const resolutionList = document.getElementById('resolutionList');
        const serverList = document.getElementById('serverList');
        
        // Button Elements
        const btnPrev = document.getElementById('btnPrev');
        const btnPlay = document.getElementById('btnPlay');
        const btnNext = document.getElementById('btnNext');
        const btnMute = document.getElementById('btnMute');
        const btnFav = document.getElementById('btnFav');
        const btnGuide = document.getElementById('btnGuide');
        const btnSettings = document.getElementById('btnSettings');
        const btnFullscreen = document.getElementById('btnFullscreen');
        const btnCloseGuide = document.getElementById('btnCloseGuide');
        const btnCloseSettings = document.getElementById('btnCloseSettings');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, checking channels...');
            console.log('Channels loaded from main.js:', channels.length);
            
            // If channels not loaded from main.js, use fallback
            if (!channels || channels.length === 0) {
                console.warn('No channels found, using fallback');
                channels = getDefaultChannels();
            }
            
            // Initialize Shaka Player
            await initPlayer();
            
            // Setup event listeners
            setupEventListeners();
            
            // Build categories
            buildCategories();
            
            // Load last channel or first channel
            const savedIndex = localStorage.getItem('lastChannel');
            playChannel(savedIndex ? parseInt(savedIndex) : 0);
            
            // Start controls timer
            resetControlsTimer();
            
            console.log('Player initialized successfully');
        });
        
        // Initialize Shaka Player
        async function initPlayer() {
            if (!shaka.Player.isBrowserSupported()) {
                console.error('Shaka Player not supported in this browser');
                showNoSignal(true, 'Browser not supported. Please use a modern browser.');
                return;
            }
            
            try {
                player = new shaka.Player(video);
                
                // Listen for error events
                player.addEventListener('error', onPlayerErrorEvent);
                
                // Listen for loaded events
                player.addEventListener('loaded', () => {
                    console.log('Stream loaded successfully');
                    updateResolutionMenu();
                });
                
                console.log('Shaka Player initialized');
            } catch (error) {
                console.error('Error initializing Shaka Player:', error);
            }
        }
        
        // Player error handler
        function onPlayerErrorEvent(event) {
            console.error('Player error:', event.detail);
            showNoSignal(true, `Player error: ${event.detail.code}`);
        }
        
        // Favorites functions
        function loadFavorites() {
            try {
                const favs = localStorage.getItem(FAV_KEY);
                if (favs) {
                    return new Set(JSON.parse(favs));
                }
            } catch (error) {
                console.error('Error loading favorites:', error);
            }
            return new Set();
        }
        
        function saveFavorites(set) {
            try {
                localStorage.setItem(FAV_KEY, JSON.stringify([...set]));
            } catch (error) {
                console.error('Error saving favorites:', error);
            }
        }
        
        // Play channel by index
        async function playChannel(index) {
            if (!channels || channels.length === 0) {
                console.error('No channels available');
                showNoSignal(true, 'No channels available');
                return;
            }
            
            hideLogo();
            
            currentIndex = clamp(index, 0, channels.length - 1);
            localStorage.setItem('lastChannel', String(currentIndex));
            currentSourceIndex = 0;
            
            // Update UI
            updateNowPlayingUI();
            buildGrid();
            
            showNoSignal(false);
            showLoading(true);
            showInfoBar(true, 10000);
            
            await tryLoadSourceLoop();
        }
        
        // Try loading sources sequentially
        async function tryLoadSourceLoop() {
            const channel = channels[currentIndex];
            
            if (!channel) {
                console.error('Channel not found at index:', currentIndex);
                await failAllSources('Channel not found');
                return;
            }
            
            const sources = channel.sources || [];
            
            if (!sources.length) {
                await failAllSources('No sources available');
                return;
            }
            
            while (currentSourceIndex < sources.length) {
                const success = await loadSource(currentSourceIndex);
                if (success) {
                    showLoading(false);
                    showNoSignal(false);
                    setBadge('LIVE', 'live');
                    return;
                }
                currentSourceIndex++;
            }
            
            await failAllSources('Switching to next channel…');
        }
        
        // Load specific source
        async function loadSource(sourceIndex) {
            const channel = channels[currentIndex];
            if (!channel) return false;
            
            const sources = channel.sources || [];
            if (!sources[sourceIndex]) return false;
            
            const source = sources[sourceIndex];
            
            if (!source || !source.url) return false;
            
            setBadge(`Loading ${source.name || 'Server ' + (sourceIndex + 1)}…`, 'warn');
            showLoading(true);
            showNoSignal(false);
            hideLogo();
            
            try {
                // Clear previous DRM config
                player.configure({
                    drm: { clearKeys: {} }
                });
                
                // Configure DRM if available
                if (source.drm && source.drm.clearkey) {
                    player.configure({
                        drm: { clearKeys: source.drm.clearkey }
                    });
                } else if (source.drm && source.drm.kid && source.drm.key) {
                    // Support for old DRM format
                    player.configure({
                        drm: { clearKeys: { [source.drm.kid]: source.drm.key } }
                    });
                }
                
                // Load the stream
                await player.load(source.url);
                
                // Try to play
                try {
                    video.muted = false;
                    await video.play();
                } catch (playError) {
                    // Fallback to muted autoplay
                    console.log('Autoplay blocked, trying muted:', playError);
                    video.muted = true;
                    await video.play();
                    setBadge('Muted. Press play to unmute', 'warn');
                }
                
                updateMuteIcon();
                updatePlayIcon();
                
                // Show watermark after a delay
                setTimeout(() => showLogo(), 500);
                
                console.log('Source loaded successfully:', sourceIndex);
                return true;
            } catch (error) {
                console.warn('Source failed:', sourceIndex, error);
                setBadge(`Source failed → trying next`, 'warn');
                return false;
            }
        }
        
        // Handle all sources failing
        async function failAllSources(message) {
            showLoading(false);
            showNoSignal(true, message);
            setBadge('NO SIGNAL', 'err');
            hideLogo();
            
            await new Promise(resolve => setTimeout(resolve, 1600));
            showNoSignal(false);
            await playChannel((currentIndex + 1) % channels.length);
        }
        
        // UI Controls
        function showControls() {
            customControls.classList.remove('hidden');
            isControlsVisible = true;
            document.getElementById('video-container').style.cursor = 'auto';
            resetControlsTimer();
        }
        
        function hideControls() {
            if (!isFullscreen && !isControlsVisible) return;
            
            customControls.classList.add('hidden');
            isControlsVisible = false;
            
            if (isFullscreen) {
                document.getElementById('video-container').style.cursor = 'none';
            }
        }
        
        function resetControlsTimer() {
            clearTimeout(controlsTimeout);
            const delay = isFullscreen ? HIDE_DELAY : HIDE_DELAY_NON_FULLSCREEN;
            controlsTimeout = setTimeout(hideControls, delay);
        }
        
        // Info Bar functions
        function showInfoBar(sticky = false, timeout = 8000) {
            infoBar.classList.add('show');
            clearTimeout(infoHideTimer);
            infoHideTimer = setTimeout(() => {
                infoBar.classList.remove('show');
            }, sticky ? 8000 : timeout);
        }
        
        function setBadge(text, kind) {
            const base = getChannelSubText();
            infoSub.innerHTML = escapeHtml(base) + ` <span class="badge ${kind || 'warn'}">${escapeHtml(text)}</span>`;
            showInfoBar(true, 8000);
        }
        
        function getChannelSubText() {
            const channel = channels[currentIndex];
            if (!channel) return '';
            
            const category = channel.category || 'General';
            const desc = channel.description ? ` • ${channel.description}` : '';
            const source = channel.sources?.[currentSourceIndex];
            const sourceName = source?.name ? ` • ${source.name}` : (channel.sources?.length ? ` • Server ${currentSourceIndex + 1}` : '');
            return `${category}${desc}${sourceName}`;
        }
        
        function updateNowPlayingUI() {
            const channel = channels[currentIndex];
            if (!channel) return;
            
            infoLogo.src = channel.img || '';
            infoTitle.textContent = `${currentIndex + 1}. ${channel.name || 'Unknown'}`;
            infoSub.textContent = getChannelSubText();
            
            updateFavIcon();
            updatePlayIcon();
            updateMuteIcon();
        }
        
        // Playback controls
        function togglePlay() {
            if (!video) return;
            
            if (video.paused) {
                video.play();
                showLogo();
            } else {
                video.pause();
            }
            updatePlayIcon();
            showInfoBar(true, 8000);
        }
        
        function updatePlayIcon() {
            if (!video) return;
            playIcon.className = video.paused ? 'fas fa-play' : 'fas fa-pause';
        }
        
        function toggleMute() {
            if (!video) return;
            
            video.muted = !video.muted;
            updateMuteIcon();
            showInfoBar(true, 8000);
        }
        
        function updateMuteIcon() {
            if (!video) return;
            muteIcon.className = video.muted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
        }
        
        function nextChannel() {
            if (!channels || channels.length === 0) return;
            playChannel((currentIndex + 1) % channels.length);
        }
        
        function prevChannel() {
            if (!channels || channels.length === 0) return;
            playChannel((currentIndex - 1 + channels.length) % channels.length);
        }
        
        // Favorites
        function updateFavIcon() {
            const channel = channels[currentIndex];
            if (!channel?.name) return;
            
            const isFavorite = favorites.has(channel.name);
            favIcon.style.color = isFavorite ? '#ffd54a' : '#fff';
            btnFav.classList.toggle('star-on', isFavorite);
        }
        
        function toggleFavCurrent() {
            const channel = channels[currentIndex];
            if (!channel?.name) return;
            
            if (favorites.has(channel.name)) {
                favorites.delete(channel.name);
            } else {
                favorites.add(channel.name);
            }
            
            saveFavorites(favorites);
            updateFavIcon();
            buildGrid();
            showInfoBar(true, 8000);
        }
        
        function toggleFavByIndex(index) {
            const channel = channels[index];
            if (!channel?.name) return;
            
            if (favorites.has(channel.name)) {
                favorites.delete(channel.name);
            } else {
                favorites.add(channel.name);
            }
            
            saveFavorites(favorites);
            updateFavIcon();
            buildGrid();
        }
        
        // Guide functions
        function buildCategories() {
            if (!channels || channels.length === 0) {
                categories = ["All"];
                currentCategory = "All";
                return;
            }
            
            const categorySet = new Set(channels.map(c => c.category || 'General'));
            categories = ['★ Favorites', 'All', ...[...categorySet].sort()];
            currentCategory = 'All';
            focusCatIndex = categories.indexOf(currentCategory);
        }
        
        function toggleGuide(force) {
            const wantOpen = (typeof force === 'boolean') ? force : !guideModal.classList.contains('show');
            
            if (wantOpen && settingsOverlay.classList.contains('show')) {
                toggleSettings(false);
                setTimeout(() => {
                    guideModal.classList.toggle('show', true);
                    focusCatIndex = categories.indexOf(currentCategory);
                    if (focusCatIndex < 0) focusCatIndex = 0;
                    
                    buildCategoriesUI();
                    buildGrid();
                    
                    const pos = filteredIndexes.indexOf(currentIndex);
                    focusTileIndex = pos >= 0 ? pos : 0;
                    updateGridFocus();
                    
                    setTimeout(() => searchInput.focus(), 50);
                }, 200);
                return;
            }
            
            guideModal.classList.toggle('show', wantOpen);
            
            if (wantOpen) {
                focusCatIndex = categories.indexOf(currentCategory);
                if (focusCatIndex < 0) focusCatIndex = 0;
                
                buildCategoriesUI();
                buildGrid();
                
                const pos = filteredIndexes.indexOf(currentIndex);
                focusTileIndex = pos >= 0 ? pos : 0;
                updateGridFocus();
                
                setTimeout(() => searchInput.focus(), 50);
            } else {
                searchInput.blur();
            }
            showInfoBar(true, 8000);
        }
        
        function buildCategoriesUI() {
            categoriesPanel.innerHTML = '';
            categories.forEach((category, index) => {
                const item = document.createElement('div');
                item.className = 'category-item' + (index === focusCatIndex ? ' focus' : '');
                item.textContent = category;
                item.onclick = () => {
                    focusCatIndex = index;
                    currentCategory = categories[focusCatIndex];
                    focusTileIndex = 0;
                    buildCategoriesUI();
                    buildGrid();
                    updateGridFocus();
                };
                categoriesPanel.appendChild(item);
            });
        }
        
        function getFilteredIndexes() {
            if (!channels || channels.length === 0) return [];
            
            const query = (searchInput.value || '').trim().toLowerCase();
            const isFav = currentCategory === '★ Favorites';
            const isAll = currentCategory === 'All';
            
            const indexes = [];
            for (let i = 0; i < channels.length; i++) {
                const channel = channels[i];
                const category = channel.category || 'General';
                
                if (isFav && !favorites.has(channel.name)) continue;
                if (!isFav && !isAll && category !== currentCategory) continue;
                
                if (query) {
                    const searchString = `${i + 1} ${channel.name || ''} ${category} ${channel.description || ''}`.toLowerCase();
                    if (!searchString.includes(query)) continue;
                }
                
                indexes.push(i);
            }
            return indexes;
        }
        
        function updateGridFocus() {
            const tiles = channelsGrid.querySelectorAll('.channel-tile');
            tiles.forEach((tile, index) => {
                tile.classList.remove('focus');
                if (index === focusTileIndex) {
                    tile.classList.add('focus');
                    tile.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }
        
        function buildGrid() {
            filteredIndexes = getFilteredIndexes();
            if (focusTileIndex >= filteredIndexes.length) {
                focusTileIndex = Math.max(0, filteredIndexes.length - 1);
            }
            
            channelsGrid.innerHTML = '';
            
            filteredIndexes.forEach((channelIndex, tileIndex) => {
                const channel = channels[channelIndex];
                if (!channel) return;
                
                const isFavorite = favorites.has(channel.name);
                
                const tile = document.createElement('div');
                tile.className = 'channel-tile' + (tileIndex === focusTileIndex ? ' focus' : '');
                tile.dataset.channelIndex = channelIndex;
                
                tile.onclick = () => {
                    focusTileIndex = tileIndex;
                    updateGridFocus();
                    toggleGuide(false);
                    playChannel(channelIndex);
                };
                
                tile.innerHTML = `
                    <img class="channel-logo" src="${channel.img || ''}" alt="${escapeHtml(channel.name || '')}" onerror="this.src='https://via.placeholder.com/70?text=No+Logo'">
                    <div class="channel-name">${escapeHtml(channel.name || 'Channel ' + (channelIndex + 1))}</div>
                    <button class="favorite-btn ${isFavorite ? 'on' : ''}" title="Favorite">
                        <i class="fas fa-star"></i>
                    </button>
                `;
                
                const favBtn = tile.querySelector('.favorite-btn');
                if (favBtn) {
                    favBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleFavByIndex(channelIndex);
                    };
                }
                
                channelsGrid.appendChild(tile);
            });
            
            updateGridFocus();
        }
        
        // Settings functions
        function toggleSettings(force) {
            const wantOpen = (typeof force === 'boolean') ? force : !settingsOverlay.classList.contains('show');
            
            if (wantOpen && guideModal.classList.contains('show')) {
                toggleGuide(false);
                setTimeout(() => {
                    settingsOverlay.classList.toggle('show', true);
                    updateResolutionMenu();
                    loadServerSources();
                    showInfoBar(true, 8000);
                }, 200);
                return;
            }
            
            settingsOverlay.classList.toggle('show', wantOpen);
            
            if (wantOpen) {
                updateResolutionMenu();
                loadServerSources();
                showInfoBar(true, 8000);
            }
        }
        
        function updateResolutionMenu() {
            if (!resolutionList) return;
            
            resolutionList.innerHTML = '';
            
            let qualities = [];
            if (player) {
                try {
                    const tracks = player.getVariantTracks();
                    qualities = tracks.map(track => ({
                        id: track.id,
                        label: track.height ? `${track.height}p` : `${Math.round(track.bandwidth / 1000)}kbps`,
                        height: track.height,
                        selected: track.active
                    }));
                } catch (error) {
                    console.warn('Could not get variant tracks:', error);
                }
            }
            
            // Auto option
            const autoOption = document.createElement('div');
            autoOption.className = 'settings-option active';
            autoOption.innerHTML = `
                <div class="option-label">Auto (Best)</div>
                <div class="option-value">✓</div>
            `;
            autoOption.onclick = () => selectResolution(-1, 'Auto');
            resolutionList.appendChild(autoOption);
            
            // Available qualities
            qualities.forEach(quality => {
                const option = document.createElement('div');
                option.className = `settings-option ${quality.selected ? 'active' : ''}`;
                option.innerHTML = `
                    <div class="option-label">${quality.label}</div>
                    <div class="option-value">${quality.selected ? '✓' : ''}</div>
                `;
                option.onclick = () => selectResolution(quality.id, quality.label);
                resolutionList.appendChild(option);
            });
        }
        
        function selectResolution(id, label) {
            if (player && id !== -1) {
                try {
                    const tracks = player.getVariantTracks();
                    const track = tracks.find(t => t.id === id);
                    if (track) {
                        player.selectVariantTrack(track, true);
                    }
                } catch (error) {
                    console.error('Error selecting resolution:', error);
                }
            }
            
            setBadge(`Resolution: ${label}`, 'live');
            toggleSettings(false);
        }
        
        function loadServerSources() {
            if (!serverList) return;
            
            serverList.innerHTML = '';
            
            const channel = channels[currentIndex];
            if (!channel) return;
            
            const sources = channel.sources || [];
            
            if (sources.length <= 1) {
                const noOpt = document.createElement('div');
                noOpt.className = 'settings-option';
                noOpt.innerHTML = `
                    <div class="option-label">Only one server available</div>
                `;
                serverList.appendChild(noOpt);
                return;
            }
            
            sources.forEach((source, index) => {
                const option = document.createElement('div');
                option.className = `settings-option ${index === currentSourceIndex ? 'active' : ''}`;
                const sourceName = source.name || `Server ${index + 1}`;
                const sourceType = source.type ? ` (${source.type.toUpperCase()})` : '';
                option.innerHTML = `
                    <div class="option-label">${sourceName}${sourceType}</div>
                    <div class="option-value">${index === currentSourceIndex ? '✓' : ''}</div>
                `;
                option.onclick = () => selectServerSource(index, sourceName);
                serverList.appendChild(option);
            });
        }
        
        function selectServerSource(index, name) {
            currentSourceIndex = index;
            setBadge(`Switched to ${name}`, 'live');
            toggleSettings(false);
            
            showLoading(true);
            setTimeout(() => {
                loadSource(currentSourceIndex).then(success => {
                    if (success) {
                        showLoading(false);
                        updateNowPlayingUI();
                    } else {
                        showLoading(false);
                    }
                });
            }, 300);
        }
        
        // Fullscreen
        function toggleFullscreen() {
            const container = document.getElementById('video-container');
            
            if (!isFullscreen) {
                if (container.requestFullscreen) container.requestFullscreen();
                else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
                else if (container.msRequestFullscreen) container.msRequestFullscreen();
                
                fullscreenIcon.className = 'fas fa-compress';
                isFullscreen = true;
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
                
                fullscreenIcon.className = 'fas fa-expand';
                isFullscreen = false;
            }
            
            showInfoBar(true, 8000);
        }
        
        // Logo control
        function showLogo() {
            videoLogoWatermark.classList.remove('hidden');
        }
        
        function hideLogo() {
            videoLogoWatermark.classList.add('hidden');
        }
        
        // Loading control
        function showLoading(show) {
            if (show) {
                loadingOverlay.classList.add('show');
            } else {
                loadingOverlay.classList.remove('show');
            }
        }
        
        // No signal control
        function showNoSignal(show, message) {
            if (show) {
                noSignal.classList.add('show');
                if (message) noSignalText.textContent = message;
            } else {
                noSignal.classList.remove('show');
            }
        }
        
        // Utility functions
        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Fallback channels if main.js cannot be loaded
        function getDefaultChannels() {
            return [
                {
                    name: "Sangsad TV",
                    sources: [
                        { name: "Server 1", url: "https://tplay.live/out/news/bd-sangsad.index.m3u8" }
                    ],
                    img: "https://i.postimg.cc/RVR9YF6Y/sangsad.jpg",
                    category: "News",
                    description: "Bangladesh"
                },
                {
                    name: "BTV",
                    sources: [
                        { name: "Server 1", url: "https://bongoflixbd.top/stream.php?id=a0e6e9b6-b20b-4f54-82d6-881bef762cfd&e.m3u8" },
                        { name: "Server 2", url: "https://owrcovcrpy.gpcdn.net/bpk-tv/1709/output/index.m3u8" }
                    ],
                    img: "https://i.postimg.cc/nzQXt33R/btv.jpg",
                    category: "Mix-Entertainment",
                    description: "Bangladesh"
                }
            ];
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Mouse/touch events for controls
            const videoContainer = document.getElementById('video-container');
            videoContainer.addEventListener('mousemove', showControls);
            videoContainer.addEventListener('touchstart', showControls, { passive: true });
            
            // Video events
            video.addEventListener('play', () => {
                updatePlayIcon();
                showLogo();
            });
            
            video.addEventListener('pause', updatePlayIcon);
            
            video.addEventListener('waiting', () => {
                hideLogo();
            });
            
            video.addEventListener('playing', () => {
                showLogo();
            });
            
            video.addEventListener('timeupdate', () => {
                const currentTime = formatTime(video.currentTime);
                const duration = formatTime(video.duration);
                timeDisplay.textContent = `${currentTime} / ${duration}`;
                
                const progressPercent = (video.currentTime / video.duration) * 100;
                progressBar.style.width = `${progressPercent}%`;
            });
            
            // Progress bar seeking
            progressContainer.addEventListener('click', (e) => {
                const rect = progressContainer.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                video.currentTime = percent * video.duration;
                resetControlsTimer();
            });
            
            // Volume control
            volumeSlider.addEventListener('input', () => {
                video.volume = volumeSlider.value;
                if (video.volume == 0) {
                    muteIcon.className = 'fas fa-volume-mute';
                } else {
                    muteIcon.className = 'fas fa-volume-up';
                }
                resetControlsTimer();
            });
            
            // Button click events
            btnPrev.onclick = prevChannel;
            btnPlay.onclick = togglePlay;
            btnNext.onclick = nextChannel;
            btnMute.onclick = toggleMute;
            btnFav.onclick = toggleFavCurrent;
            btnGuide.onclick = () => toggleGuide();
            btnSettings.onclick = () => toggleSettings();
            btnFullscreen.onclick = toggleFullscreen;
            btnCloseGuide.onclick = () => toggleGuide(false);
            btnCloseSettings.onclick = () => toggleSettings(false);
            
            // Search input
            searchInput.addEventListener('input', () => {
                focusTileIndex = 0;
                buildGrid();
                updateGridFocus();
            });
            
            // Fullscreen change
            document.addEventListener('fullscreenchange', () => {
                isFullscreen = !!document.fullscreenElement;
                fullscreenIcon.className = isFullscreen ? 'fas fa-compress' : 'fas fa-expand';
                if (isFullscreen) {
                    showLogo();
                }
            });
            
            // Keyboard/remote control
            document.addEventListener('keydown', handleKeyPress);
        }
        
        // Keyboard/remote control handler
        function handleKeyPress(e) {
            const inSearch = document.activeElement === searchInput;
            const guideOpen = guideModal.classList.contains('show');
            const settingsOpen = settingsOverlay.classList.contains('show');
            
            if (inSearch) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchInput.blur();
                    if (filteredIndexes.length > 0 && focusTileIndex < filteredIndexes.length) {
                        const channelIndex = filteredIndexes[focusTileIndex];
                        toggleGuide(false);
                        setTimeout(() => playChannel(channelIndex), 100);
                    }
                    return;
                }
                return;
            }
            
            // Prevent default for navigation keys
            if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Enter', 'Escape', 'f', 'F', 's', 'S', 'g', 'G'].includes(e.key)) {
                e.preventDefault();
            }
            
            // Remote/keyboard mapping
            switch (e.key) {
                case 'ArrowLeft':
                    if (!guideOpen && !settingsOpen) {
                        prevChannel();
                    } else if (guideOpen) {
                        focusCatIndex = Math.max(0, focusCatIndex - 1);
                        currentCategory = categories[focusCatIndex];
                        focusTileIndex = 0;
                        buildCategoriesUI();
                        buildGrid();
                        updateGridFocus();
                    }
                    break;
                    
                case 'ArrowRight':
                    if (!guideOpen && !settingsOpen) {
                        nextChannel();
                    } else if (guideOpen) {
                        focusCatIndex = Math.min(categories.length - 1, focusCatIndex + 1);
                        currentCategory = categories[focusCatIndex];
                        focusTileIndex = 0;
                        buildCategoriesUI();
                        buildGrid();
                        updateGridFocus();
                    }
                    break;
                    
                case 'ArrowUp':
                    if (!guideOpen && !settingsOpen) {
                        toggleGuide(true);
                    } else if (guideOpen) {
                        const cols = Math.max(1, Math.floor(channelsGrid.clientWidth / 120));
                        focusTileIndex = Math.max(0, focusTileIndex - cols);
                        updateGridFocus();
                    }
                    break;
                    
                case 'ArrowDown':
                    if (!guideOpen && !settingsOpen) {
                        // Down arrow opens settings
                        toggleSettings();
                    } else if (guideOpen) {
                        const cols = Math.max(1, Math.floor(channelsGrid.clientWidth / 120));
                        focusTileIndex = Math.min(filteredIndexes.length - 1, focusTileIndex + cols);
                        updateGridFocus();
                    }
                    break;
                    
                case 'Enter':
                    if (!guideOpen && !settingsOpen) {
                        // Single click: Play/Pause
                        if (okClickTimer) {
                            clearTimeout(okClickTimer);
                            okClickTimer = null;
                            // Double click: Toggle Favorite
                            toggleFavCurrent();
                            setBadge('Favorite updated', 'live');
                        } else {
                            okClickTimer = setTimeout(() => {
                                togglePlay();
                                okClickTimer = null;
                            }, DOUBLE_CLICK_DELAY);
                        }
                    } else if (guideOpen) {
                        // Select channel
                        if (filteredIndexes.length > 0 && focusTileIndex < filteredIndexes.length) {
                            const channelIndex = filteredIndexes[focusTileIndex];
                            toggleGuide(false);
                            setTimeout(() => playChannel(channelIndex), 100);
                        }
                    }
                    break;
                    
                case 'Escape':
                    if (backClickTimer) {
                        clearTimeout(backClickTimer);
                        backClickTimer = null;
                        if (confirm('Exit T Play?')) {
                            window.close();
                        }
                    } else {
                        backClickTimer = setTimeout(() => {
                            if (settingsOpen) {
                                toggleSettings(false);
                            } else if (guideOpen) {
                                toggleGuide(false);
                            } else if (infoBar.classList.contains('show')) {
                                infoBar.classList.remove('show');
                            }
                            backClickTimer = null;
                        }, DOUBLE_CLICK_DELAY);
                    }
                    break;
                    
                case 'f':
                case 'F':
                    toggleFullscreen();
                    break;
                    
                case 's':
                case 'S':
                    toggleSettings();
                    break;
                    
                case 'g':
                case 'G':
                    if (!settingsOpen) {
                        toggleGuide();
                    }
                    break;
            }
            
            // Show controls when key is pressed
            showControls();
        }
        
        // Format time helper
        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>
