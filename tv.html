<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T Play TV</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,sans-serif}
body{background:#000;color:#fff;overflow:hidden}
.video-container{position:relative;width:100vw;height:100vh;background:#000}
#video{width:100%;height:100%;object-fit:fill}

/* CONTROLS */
.controls{
    position:absolute;bottom:20px;left:50%;
    transform:translateX(-50%);
    display:flex;gap:10px;
    padding:10px 16px;
    background:rgba(0,0,0,.6);
    border-radius:40px;
    opacity:0;pointer-events:none;
    transition:.3s;z-index:40
}
.controls.show{opacity:1;pointer-events:auto}
.control-btn{
    width:38px;height:38px;border-radius:50%;
    border:none;background:rgba(255,255,255,.15);
    color:#fff;cursor:pointer
}
.control-btn:hover{background:#e50914}

/* DTH OVERLAY */
.dth-overlay{
    position:absolute;inset:0;
    background:rgba(0,0,0,.92);
    display:none;flex-direction:column;
    z-index:80
}
.dth-overlay.show{display:flex}
.dth-top{
    padding:12px 18px;
    display:flex;justify-content:space-between;
    background:#111
}
.now-playing{
    display:flex;gap:12px;
    padding:10px 18px;
    background:#1a1a1a
}
.now-playing img{width:46px;height:46px;border-radius:6px}
.dth-body{flex:1;display:flex;overflow:hidden}
.category-panel{
    width:160px;background:#111;overflow-y:auto
}
.category-panel div{
    padding:12px;color:#aaa;cursor:pointer
}
.category-panel div.active{
    background:#e50914;color:#fff
}
.channel-panel{flex:1;display:flex;flex-direction:column}
.channel-search{padding:10px}
.channel-search input{
    width:100%;padding:8px 12px;border-radius:20px;border:none
}
.channel-list{flex:1;overflow-y:auto}
.channel-row{
    display:flex;align-items:center;gap:12px;
    padding:10px 14px;border-bottom:1px solid #222;
    cursor:pointer
}
.channel-row.active,
.channel-row:hover{background:#222}
.channel-row span{width:40px;text-align:right;color:#aaa}
.channel-row img{width:40px;height:40px;border-radius:6px}
</style>
</head>

<body>

<div class="video-container">

<video id="video" autoplay muted playsinline></video>

<div class="controls">
    <button class="control-btn" onclick="prevChannel()"><i class="fas fa-chevron-left"></i></button>
    <button class="control-btn" onclick="togglePlay()"><i id="playIcon" class="fas fa-play"></i></button>
    <button class="control-btn" onclick="toggleMute()"><i id="muteIcon" class="fas fa-volume-up"></i></button>
    <button class="control-btn" onclick="toggleGuide()"><i class="fas fa-list"></i></button>
    <button class="control-btn" onclick="nextChannel()"><i class="fas fa-chevron-right"></i></button>
</div>

<div class="dth-overlay" id="guide">
    <div class="dth-top">
        <b>Channel Guide</b>
        <button onclick="toggleGuide()">âœ•</button>
    </div>

    <div class="now-playing">
        <img id="nowImg">
        <div>
            <b id="nowName"></b><br>
            <small id="nowCat"></small>
        </div>
    </div>

    <div class="dth-body">
        <div class="category-panel" id="catPanel"></div>
        <div class="channel-panel">
            <div class="channel-search">
                <input placeholder="Search channel..." oninput="searchChannel(this.value)">
            </div>
            <div class="channel-list" id="chList"></div>
        </div>
    </div>
</div>

</div>

<script src="main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.12/shaka-player.compiled.js"></script>

<script>
const video=document.getElementById("video");
let hls=null,shakaP=null,currentIndex=0,currentCat="All";

/* INIT */
window.onload=()=>{
    const saved=localStorage.getItem("lastChannel");
    playChannel(saved?+saved:0);
    buildCategories();
    buildList();
    showControls();
};

/* PLAY CHANNEL (HLS + MPD + DRM) */
async function playChannel(i){
    currentIndex=i;
    localStorage.setItem("lastChannel",i);

    if(hls){hls.destroy();hls=null}
    if(shakaP){await shakaP.destroy();shakaP=null}

    const ch=channels[i];
    const src=ch.sources[0];
    const url=src.url;

    document.getElementById("nowImg").src=ch.img;
    document.getElementById("nowName").textContent=ch.name;
    document.getElementById("nowCat").textContent=ch.category;

    if(src.type==="dash" || url.includes(".mpd")){
        shaka.polyfill.installAll();
        shakaP=new shaka.Player(video);

        if(src.drm){
            await shakaP.configure({
                drm:{clearKeys:{[src.drm.kid]:src.drm.key}}
            });
        }
        await shakaP.load(url);
        video.play();
        return;
    }

    if(Hls.isSupported()){
        hls=new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED,()=>video.play());
    }else{
        video.src=url;
        video.play();
    }
}

/* CONTROLS */
function togglePlay(){
    const i=document.getElementById("playIcon");
    video.paused?(video.play(),i.className="fas fa-pause")
                 :(video.pause(),i.className="fas fa-play");
}
function toggleMute(){
    const i=document.getElementById("muteIcon");
    video.muted=!video.muted;
    i.className=video.muted?"fas fa-volume-mute":"fas fa-volume-up";
}
function nextChannel(){playChannel((currentIndex+1)%channels.length)}
function prevChannel(){playChannel((currentIndex-1+channels.length)%channels.length)}
function toggleGuide(){
    document.getElementById("guide").classList.toggle("show");
}

/* GUIDE UI */
function buildCategories(){
    const cats=["All",...new Set(channels.map(c=>c.category))];
    const p=document.getElementById("catPanel");
    p.innerHTML="";
    cats.forEach(c=>{
        const d=document.createElement("div");
        d.textContent=c;
        if(c==="All")d.classList.add("active");
        d.onclick=()=>{
            currentCat=c;
            [...p.children].forEach(x=>x.classList.remove("active"));
            d.classList.add("active");
            buildList();
        };
        p.appendChild(d);
    });
}
function buildList(){
    const l=document.getElementById("chList");
    l.innerHTML="";
    channels.forEach((c,i)=>{
        if(currentCat!=="All" && c.category!==currentCat)return;
        const r=document.createElement("div");
        r.className="channel-row"+(i===currentIndex?" active":"");
        r.innerHTML=`<span>${i+1}</span><img src="${c.img}"><div>${c.name}</div>`;
        r.onclick=()=>{playChannel(i);toggleGuide()};
        l.appendChild(r);
    });
}
function searchChannel(q){
    q=q.toLowerCase();
    document.querySelectorAll(".channel-row").forEach(r=>{
        r.style.display=r.textContent.toLowerCase().includes(q)?"flex":"none";
    });
}

/* AUTO CONTROLS */
let ct;
function showControls(){
    document.querySelector(".controls").classList.add("show");
    clearTimeout(ct);
    ct=setTimeout(()=>document.querySelector(".controls").classList.remove("show"),3000);
}
video.addEventListener("mousemove",showControls);
video.addEventListener("touchstart",showControls);
</script>

</body>
</html>
