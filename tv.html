<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T Play TV</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,sans-serif}
body{background:#000;color:#fff;overflow:hidden}

/* VIDEO */
.video-container{position:relative;width:100vw;height:100vh}
#video{width:100%;height:100%;object-fit:fill;background:#000}

/* ===== INFO BAR ===== */
.infoBar{
  position:absolute;left:50%;bottom:22px;transform:translateX(-50%);
  width:min(1100px,92vw);
  background:rgba(0,0,0,.75);
  backdrop-filter:blur(8px);
  border-radius:18px;
  padding:12px 16px;
  display:flex;align-items:center;gap:14px;
  opacity:0;pointer-events:none;
  transition:.2s;z-index:60
}
.infoBar.show{opacity:1;pointer-events:auto}

.infoLeft{display:flex;align-items:center;gap:12px;flex:1}
.infoLeft img{width:54px;height:54px;border-radius:12px}
.infoText b{font-size:17px}
.infoText small{color:#bbb}

.infoRight{display:flex;gap:10px}
.btn{
  width:42px;height:42px;border-radius:50%;
  border:none;background:rgba(255,255,255,.16);
  color:#fff;font-size:15px;cursor:pointer
}
.btn:hover{background:#e50914}

/* ===== LOADING ===== */
.loading{
  position:absolute;inset:0;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.55);
  z-index:90;display:none
}
.loading.show{display:flex}
.spinner{
  width:60px;height:60px;border-radius:50%;
  border:6px solid rgba(255,255,255,.2);
  border-top-color:#e50914;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== NO SIGNAL ===== */
.no-signal{
  position:absolute;inset:0;
  background:#000;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  gap:10px;z-index:95;
  display:none
}
.no-signal.show{display:flex}
.no-signal i{font-size:60px;color:#e50914}
.no-signal span{color:#bbb}

/* ===== SOURCE SELECT ===== */
.source-popup{
  position:absolute;bottom:90px;right:30px;
  background:rgba(0,0,0,.85);
  border-radius:14px;padding:10px;
  display:none;z-index:80
}
.source-popup.show{display:block}
.source-popup div{
  padding:10px 14px;
  cursor:pointer;border-radius:10px
}
.source-popup div:hover,
.source-popup div.active{
  background:#e50914
}
</style>
</head>

<body>

<div class="video-container">

<video id="video" autoplay playsinline></video>

<!-- LOADING -->
<div id="loading" class="loading">
  <div class="spinner"></div>
</div>

<!-- NO SIGNAL -->
<div id="noSignal" class="no-signal">
  <i class="fas fa-tv"></i>
  <b>No Signal</b>
  <span>Trying next channelâ€¦</span>
</div>

<!-- INFO BAR -->
<div id="infoBar" class="infoBar">
  <div class="infoLeft">
    <img id="infoLogo">
    <div class="infoText">
      <b id="infoName"></b><br>
      <small id="infoCat"></small>
    </div>
  </div>
  <div class="infoRight">
    <button class="btn" onclick="prevChannel()"><i class="fas fa-chevron-left"></i></button>
    <button class="btn" onclick="togglePlay()"><i id="playIcon" class="fas fa-play"></i></button>
    <button class="btn" onclick="toggleMute()"><i id="muteIcon" class="fas fa-volume-up"></i></button>
    <button class="btn" onclick="toggleSourcePopup()"><i class="fas fa-server"></i></button>
    <button class="btn" onclick="nextChannel()"><i class="fas fa-chevron-right"></i></button>
  </div>
</div>

<!-- SOURCE SELECT -->
<div id="sourcePopup" class="source-popup"></div>

</div>

<script src="main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.12/shaka-player.compiled.js"></script>

<script>
const video=document.getElementById("video");
const loading=document.getElementById("loading");
const noSignal=document.getElementById("noSignal");

let hls=null,shakaP=null;
let currentIndex=0,sourceIndex=0;

/* INIT */
window.onload=()=>{
  video.muted=false;
  playChannel(0);
};

/* PLAY CHANNEL */
async function playChannel(i){
  currentIndex=i;
  sourceIndex=0;
  showLoading(true);
  await trySource();
}

/* TRY SOURCE */
async function trySource(){
  const ch=channels[currentIndex];
  const src=ch.sources[sourceIndex];

  if(!src){
    showNoSignal();
    setTimeout(()=>nextChannel(),1500);
    return;
  }

  updateInfo(ch);
  buildSourcePopup(ch);

  cleanup();

  try{
    if(src.type==="dash"||src.url.includes(".mpd")){
      shakaP=new shaka.Player(video);
      if(src.drm){
        await shakaP.configure({drm:{clearKeys:{[src.drm.kid]:src.drm.key}}});
      }
      await shakaP.load(src.url);
    }else{
      if(Hls.isSupported()){
        hls=new Hls();
        hls.loadSource(src.url);
        hls.attachMedia(video);
      }else{
        video.src=src.url;
      }
    }

    await video.play();
    showLoading(false);

  }catch(e){
    sourceIndex++;
    trySource();
  }
}

/* UI */
function updateInfo(ch){
  document.getElementById("infoLogo").src=ch.img;
  document.getElementById("infoName").textContent=ch.name;
  document.getElementById("infoCat").textContent=ch.category||"";
  showInfoBar();
}

function showLoading(v){
  loading.classList.toggle("show",v);
  noSignal.classList.remove("show");
}

function showNoSignal(){
  showLoading(false);
  noSignal.classList.add("show");
}

function showInfoBar(){
  const bar=document.getElementById("infoBar");
  bar.classList.add("show");
  setTimeout(()=>bar.classList.remove("show"),3000);
}

/* CONTROLS */
function togglePlay(){
  video.paused?video.play():video.pause();
}
function toggleMute(){
  video.muted=!video.muted;
  document.getElementById("muteIcon").className=
    video.muted?"fas fa-volume-mute":"fas fa-volume-up";
}
function nextChannel(){playChannel((currentIndex+1)%channels.length)}
function prevChannel(){playChannel((currentIndex-1+channels.length)%channels.length)}

/* SOURCE POPUP */
function buildSourcePopup(ch){
  const p=document.getElementById("sourcePopup");
  p.innerHTML="";
  ch.sources.forEach((s,i)=>{
    const d=document.createElement("div");
    d.textContent=s.name||"Server "+(i+1);
    if(i===sourceIndex)d.classList.add("active");
    d.onclick=()=>{
      sourceIndex=i;
      p.classList.remove("show");
      showLoading(true);
      trySource();
    };
    p.appendChild(d);
  });
}
function toggleSourcePopup(){
  document.getElementById("sourcePopup").classList.toggle("show");
}

/* CLEANUP */
function cleanup(){
  if(hls){hls.destroy();hls=null}
  if(shakaP){shakaP.destroy();shakaP=null}
  video.src="";
}
</script>

</body>
</html>
